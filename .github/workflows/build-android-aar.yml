name: Build Outline AAR (container)

on:
  workflow_dispatch: {}

jobs:
  build-aar:
    runs-on: ubuntu-latest
    # Готовый образ с Android SDK/NDK — не нужно ставить cmdline-tools вручную
    container:
      image: ghcr.io/cirruslabs/android-sdk:34
      options: --privileged

    env:
      ANDROID_SDK_ROOT: /opt/android-sdk
      ANDROID_HOME: /opt/android-sdk
      ANDROID_API: "26"
      BUILD_TOOLS: "34.0.0"
      NDK_VERSION: "26.1.10909125"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Go 1.22
        shell: bash
        run: |
          set -eux
          curl -sSL https://go.dev/dl/go1.22.7.linux-amd64.tar.gz -o /tmp/go.tgz
          rm -rf /usr/local/go && tar -C /usr/local -xzf /tmp/go.tgz
          echo "/usr/local/go/bin" >> $GITHUB_PATH
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Ensure SDK packages
        shell: bash
        run: |
          set -eux
          yes | sdkmanager --licenses >/dev/null
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;${BUILD_TOOLS}" "ndk;${NDK_VERSION}"

      - name: gomobile init
        shell: bash
        env:
          ANDROID_NDK_HOME: /opt/android-sdk/ndk/${{ env.NDK_VERSION }}
        run: |
          set -eux
          go install golang.org/x/mobile/cmd/gomobile@latest
          gomobile init -ndk "$ANDROID_NDK_HOME"

      - name: Build AAR
        shell: bash
        env:
          ANDROID_NDK_HOME: /opt/android-sdk/ndk/${{ env.NDK_VERSION }}
        run: |
          set -eux
          mkdir -p build/android
          # Если у тебя не ./x/mobile – замени путь на свой пакет
          gomobile bind -target=android -androidapi "${ANDROID_API}" \
            -o build/android/outline.aar ./x/mobile
          ls -l build/android

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: outline-aar
          path: build/android/outline.aar
          if-no-files-found: error
