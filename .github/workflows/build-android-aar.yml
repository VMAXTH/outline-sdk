name: Build Android AAR

on:
  workflow_dispatch:
    inputs:
      pkg_path:
        description: "Go-пакет для gomobile (пример: ./x/mobileapi)"
        required: true
        default: ./x/mobileapi

jobs:
  build-aar:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Go 1.22
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      - name: Prepare SDK folders
        run: |
          set -euxo pipefail
          sudo mkdir -p /usr/local/lib/android/sdk
          sudo chown -R "$USER:$USER" /usr/local/lib/android
          mkdir -p "$HOME/.android"
          touch "$HOME/.android/repositories.cfg"

      - name: Install cmdline-tools (resilient)
        env:
          ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
        run: |
          set -euxo pipefail
          cd "$ANDROID_SDK_ROOT"
          mkdir -p cmdline-tools/latest
          try_urls=(
            "https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip"
            "https://dl.google.com/android/repository/commandlinetools-linux-11076702_latest.zip"
            "https://dl.google.com/android/repository/commandlinetools-linux-11079641_latest.zip"
            "https://dl.google.com/android/repository/commandlinetools-linux-11086966_latest.zip"
            "https://dl.google.com/android/repository/commandlinetools-linux-11046996_latest.zip"
          )
          ok=false
          for u in "${try_urls[@]}"; do
            if curl -fsSL "$u" -o /tmp/cmdtools.zip; then ok=true; break; fi
            sleep 1
          done
          if [ "$ok" != true ]; then
            echo 'Не удалось скачать commandlinetools (Google обновил номер). Обнови URL в workflow.' >&2
            exit 1
          fi
          unzip -q /tmp/cmdtools.zip -d cmdline-tools/latest
          rm /tmp/cmdtools.zip
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"
          echo "PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH" >> "$GITHUB_ENV"

      - name: Accept SDK licenses (CI-safe)
        run: |
          set -euxo pipefail
          yes | sdkmanager --licenses >/dev/null

      - name: Install Android packages (robust)
        env:
          ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
        run: |
          set -euxo pipefail
          retry() { n=0; until [ $n -ge 3 ]; do "$@" && break; n=$((n+1)); sleep 2; done; }
          retry sdkmanager "platform-tools" >/dev/null
          retry sdkmanager "build-tools;34.0.0" "platforms;android-34" >/dev/null
          retry sdkmanager "ndk;28.2.13673558" >/dev/null

      - name: Locate NDK
        run: |
          set -euxo pipefail
          NDK_DIR=$(ls -d /usr/local/lib/android/sdk/ndk/* | sort -V | tail -1)
          echo "ANDROID_NDK_HOME=$NDK_DIR" >> "$GITHUB_ENV"

      - name: Install gomobile & gobind
        run: |
          set -euxo pipefail
          go env -w GOINSECURE=golang.org
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: gomobile init
        run: |
          set -euxo pipefail
          gomobile version || true
          gomobile init -ndk "$ANDROID_NDK_HOME"

      - name: Tidy module (если у пакета есть go.mod)
        run: |
          set -euxo pipefail
          if [ -f "${{ github.event.inputs.pkg_path }}/go.mod" ]; then
            (cd "${{ github.event.inputs.pkg_path }}" && go mod tidy)
          else
            go mod tidy
          fi

      - name: Build AAR via gomobile bind
        run: |
          set -euxo pipefail
          mkdir -p build/android
          gomobile bind -target=android -androidapi=26 \
            -o build/android/outline.aar \
            "${{ github.event.inputs.pkg_path }}"

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: outline.aar
          path: build/android/outline.aar
          if-no-files-found: error
