name: Build Android AAR
on: { workflow_dispatch: {} }

jobs:
  build-aar:
    runs-on: ubuntu-latest

    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_API: "34"
      ANDROID_BUILD_TOOLS: "34.0.0"
      ANDROID_NDK_VER: "26.1.10909125"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java (JDK 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      - name: Add SDK tools to PATH
        shell: bash
        run: |
          set -eux
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> "$GITHUB_PATH"
          echo "$ANDROID_SDK_ROOT/platform-tools" >> "$GITHUB_PATH"

      # <-- фикс: игнорируем странный exit-code, лицензии всё равно принимаются
      - name: Accept SDK licenses (CI-safe)
        shell: bash
        run: |
          set -eux
          yes | sdkmanager --licenses --sdk_root="$ANDROID_SDK_ROOT" || true

      - name: Install SDK packages
        shell: bash
        run: |
          set -eux
          sdkmanager --sdk_root="$ANDROID_SDK_ROOT" \
            "platform-tools" \
            "platforms;android-${ANDROID_API}" \
            "build-tools;${ANDROID_BUILD_TOOLS}" \
            "ndk;${ANDROID_NDK_VER}"
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/${ANDROID_NDK_VER}" >> "$GITHUB_ENV"
          echo "$ANDROID_SDK_ROOT/build-tools/${ANDROID_BUILD_TOOLS}" >> "$GITHUB_PATH"

      - name: Install gomobile & gobind
        shell: bash
        run: |
          set -eux
          go env -w GO111MODULE=on GOPROXY=https://proxy.golang.org,direct
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: gomobile init
        shell: bash
        run: |
          set -eux
          gomobile version
          gomobile init -ndk "$ANDROID_NDK_HOME"

      # Поменяй ./x/mobile на свой пакет, если нужно
      - name: Build AAR
        shell: bash
        run: |
          set -eux
          mkdir -p build/android
          gomobile bind \
            -target=android \
            -androidapi 26 \
            -o build/android/outline.aar \
            ./x/mobile

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: outline-aar
          path: build/android/*
