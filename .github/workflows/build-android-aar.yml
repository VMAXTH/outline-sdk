name: Build Android AAR

on:
  workflow_dispatch:
    inputs:
      pkg_path:
        description: "Go-пакет для gomobile (например: ./x/mobileproxy)"
        required: true
        default: ./x/mobileproxy

jobs:
  build-aar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # Минимально поднимаем SDK; пакеты поставим вручную с ретраями
      - name: Set up Android SDK (minimal)
        uses: android-actions/setup-android@v3

      # Надёжная установка платформ, билд-тузов и NDK (с 5 попытками)
      - name: Ensure SDK packages (robust)
        shell: bash
        env:
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
        run: |
          set -euo pipefail
          pkgs=(
            "platform-tools"
            "platforms;android-34"
            "build-tools;34.0.0"
            "ndk;26.1.10909125"
          )
          for i in {1..5}; do
            yes | sdkmanager --licenses || true
            if sdkmanager --install "${pkgs[@]}"; then
              echo "OK: SDK packages installed"; break
            fi
            echo "sdkmanager failed (attempt $i). Retry…"
            rm -f "${ANDROID_SDK_ROOT}/.knownPackages" || true
            sleep $((i*15))
            if [ $i -eq 5 ]; then echo "SDK installation failed"; exit 1; fi
          done
          echo "SDK root: ${ANDROID_SDK_ROOT}"
          echo "Installed NDKs:"
          ls -1 "${ANDROID_SDK_ROOT}/ndk" || true

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install gomobile & gobind
        shell: bash
        run: |
          set -euo pipefail
          go env -w GOPROXY=https://proxy.golang.org,direct
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          echo "$HOME/go/bin" >> "$GITHUB_PATH"

      - name: gomobile init
        shell: bash
        env:
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
        run: |
          set -euo pipefail
          NDK_DIR="$(ls -1 "${ANDROID_SDK_ROOT}/ndk" | head -n1)"
          if [ -z "$NDK_DIR" ]; then
            echo "NDK not found in ${ANDROID_SDK_ROOT}/ndk"; exit 1
          fi
          export ANDROID_NDK_HOME="${ANDROID_SDK_ROOT}/ndk/${NDK_DIR}"
          export NDK_HOME="${ANDROID_NDK_HOME}"
          echo "Using NDK: ${ANDROID_NDK_HOME}"
          gomobile version || true
          gomobile init -ndk "${ANDROID_NDK_HOME}"

      # Если у выбранного пакета есть go.mod — подчистим зависимости
      - name: Tidy module (if pkg has go.mod)
        shell: bash
        run: |
          set -euo pipefail
          PKG="${{ inputs.pkg_path }}"
          if [ -f "${PKG}/go.mod" ]; then
            (cd "${PKG}" && go mod tidy)
          fi

      - name: Build AAR via gomobile bind
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p build/android
          gomobile bind -target=android -androidapi 26 \
            -o build/android/outline.aar \
            "${{ inputs.pkg_path }}"
          ls -l build/android

      - name: Upload AAR
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: outline.aar
          path: build/android/outline.aar
          if-no-files-found: error
