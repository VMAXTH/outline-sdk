name: Build Android AAR

on:
  workflow_dispatch:
    inputs:
      pkg_path:
        description: "Go-пакет для gomobile (например: ./x/mobileproxy)"
        required: true
        default: ./x/mobileproxy

jobs:
  build-aar:
    runs-on: ubuntu-latest

    env:
      ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk
      ANDROID_HOME: ${{ runner.temp }}/android-sdk
      NDK_VERSION: 26.1.10909125
      ANDROID_API: 34
      AAR_OUT: build/android/outline.aar

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Go 1.22
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      # -------- Android SDK ----------
      - name: Prepare SDK folders
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p "$ANDROID_SDK_ROOT"/{cmdline-tools/latest,platforms,platform-tools,build-tools,ndk}
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties

      - name: Install cmdline-tools (resilient)
        shell: bash
        run: |
          set -euxo pipefail
          cd "$ANDROID_SDK_ROOT"
          urls=(
            "https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip"
            "https://dl.google.com/android/repository/commandlinetools-linux-11076702_latest.zip"
            "https://dl.google.com/android/repository/commandlinetools-linux-11079641_latest.zip"
            "https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip"
          )
          ok=""
          for u in "${urls[@]}"; do
            echo "Trying: $u"
            if curl -fL --retry 5 --retry-delay 2 "$u" -o /tmp/cmdtools.zip; then ok="1"; break; fi
          done
          test -n "$ok"
          unzip -q /tmp/cmdtools.zip -d "$ANDROID_SDK_ROOT/cmdline-tools/latest"

      - name: Accept SDK licenses (CI-safe)
        shell: bash
        run: |
          set -euxo pipefail
          for i in {1..6}; do
            yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --licenses && exit 0 || true
            sleep 2
          done
          exit 1

      - name: Install SDK packages (robust)
        shell: bash
        run: |
          set -euxo pipefail
          sdk="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          pkgs=(
            "platform-tools"
            "platforms;android-${ANDROID_API}"
            "build-tools;34.0.0"
            "ndk;${NDK_VERSION}"
          )
          for i in {1..3}; do
            if yes | "$sdk" "${pkgs[@]}"; then exit 0; fi
            echo "sdkmanager retry $i"; sleep 3
          done
          exit 1

      - name: Find installed NDK
        id: ndk
        shell: bash
        run: |
          set -euxo pipefail
          ndk_dir="$ANDROID_SDK_ROOT/ndk/${NDK_VERSION}"
          test -d "$ndk_dir"
          echo "path=$ndk_dir" >> "$GITHUB_OUTPUT"

      # -------- gomobile / gobind ----------
      - name: Install gomobile & gobind
        shell: bash
        run: |
          set -euxo pipefail
          GOBIN="$(go env GOPATH)/bin"
          echo "$GOBIN" >> "$GITHUB_PATH"
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          gomobile version || true

      - name: gomobile init (use Android SDK)
        shell: bash
        run: |
          set -euxo pipefail
          gomobile init -androidsdk "$ANDROID_SDK_ROOT"

      # -------- проект / сборка AAR ----------
      - name: Tidy module (if go.mod exists)
        shell: bash
        run: |
          set -euxo pipefail
          if [ -f go.mod ]; then go mod tidy; fi
          if [ -f "${{ inputs.pkg_path }}/go.mod" ]; then (cd "${{ inputs.pkg_path }}" && go mod tidy); fi

      - name: Build AAR via gomobile bind
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p "$(dirname "$AAR_OUT")"
          gomobile bind \
            -target=android \
            -androidapi 26 \
            -o "$AAR_OUT" \
            "${{ inputs.pkg_path }}"
          ls -lah "$AAR_OUT"

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: outline.aar
          path: ${{ env.AAR_OUT }}
