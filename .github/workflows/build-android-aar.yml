name: Build Android AAR

on:
  workflow_dispatch:
    inputs:
      pkg_path:
        description: "Go-пакет для gomobile (например: ./x/mobileproxy)"
        required: true
        default: ./x/mobileproxy

jobs:
  build-aar:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_HOME: /usr/local/lib/android/sdk
      AAR_OUT: build/android/outline.aar
      # что ставим через sdkmanager
      ANDROID_PKGS: >
        platform-tools
        platforms;android-34
        build-tools;34.0.0
        ndk;26.1.10909125

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Go 1.22
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      - name: Prepare SDK folders
        shell: bash
        run: |
          set -eux
          sudo mkdir -p "$ANDROID_SDK_ROOT"
          sudo chown -R "$USER":"$USER" "$ANDROID_SDK_ROOT"
          mkdir -p "$ANDROID_SDK_ROOT"/{cmdline-tools,platforms,platform-tools,build-tools,ndk}
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/platform-tools"          >> $GITHUB_PATH

      - name: Install cmdline-tools (resilient)
        shell: bash
        run: |
          set -eux
          cd "$ANDROID_SDK_ROOT"

          # Пробуем несколько актуальных архивов cmdline-tools (Google меняет номер).
          try_urls=(
            "https://dl.google.com/android/repository/commandlinetools-linux-11076966_latest.zip"
            "https://dl.google.com/android/repository/commandlinetools-linux-11076702_latest.zip"
            "https://dl.google.com/android/repository/commandlinetools-linux-11076768_latest.zip"
            "https://dl.google.com/android/repository/commandlinetools-linux-11079608_latest.zip"
            "https://dl.google.com/android/repository/commandlinetools-linux-11070840_latest.zip"
            "https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip"
          )

          ok=false
          for u in "${try_urls[@]}"; do
            echo ">>> пробуем $u"
            if curl -fSsL "$u" -o /tmp/cmdtools.zip; then
              ok=true; break
            fi
          done
          if [ "$ok" != true ]; then
            echo "Не удалось скачать commandlinetools. Обнови список URL выше."
            exit 1
          fi

          rm -rf cmdline-tools/latest
          mkdir -p cmdline-tools/latest
          unzip -q /tmp/cmdtools.zip -d cmdline-tools/latest
          # В некоторых архивах внутри папка cmdline-tools — поправим структуру
          if [ -d cmdline-tools/latest/cmdline-tools ]; then
            mv cmdline-tools/latest/cmdline-tools/* cmdline-tools/latest/
            rmdir cmdline-tools/latest/cmdline-tools
          fi
          sdkmanager --version

      - name: Accept SDK licenses (CI-safe)
        shell: bash
        run: |
          set -eux
          # подадим ограниченное число 'y', чтобы не висело и не сыпало broken pipe
          (for i in $(seq 1 200); do echo y; done) \
            | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --licenses >/dev/null 2>&1 || true

      - name: Install SDK packages (robust)
        shell: bash
        run: |
          set -eux
          tries=0
          until (for i in $(seq 1 200); do echo y; done) \
              | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" ${ANDROID_PKGS} >/dev/null 2>&1
          do
            tries=$((tries+1))
            [ $tries -ge 3 ] && { echo "sdkmanager провалился 3 раза"; exit 1; }
            echo "Повтор через 5 секунд…"; sleep 5
          done

      - name: Find installed NDK
        id: ndk
        shell: bash
        run: |
          set -eux
          ndk_dir=$(ls -d "$ANDROID_SDK_ROOT/ndk/"*/ | sort -V | tail -1 | tr -d '/')
          echo "NDK_DIR=$ndk_dir" >> $GITHUB_ENV
          echo "ndk=$ndk_dir" >> $GITHUB_OUTPUT

      - name: Install gomobile & gobind
        shell: bash
        run: |
          set -eux
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          gomobile version || true

      - name: gomobile init
        shell: bash
        run: |
          set -eux
          gomobile init -ndk "$NDK_DIR"

      - name: Tidy module (if pkg has go.mod)
        shell: bash
        run: |
          set -eux
          PKG="${{ github.event.inputs.pkg_path }}"
          if [ -f "$PKG/go.mod" ]; then
            pushd "$PKG"
            go mod tidy
            popd
          fi

      - name: Build AAR via gomobile bind
        shell: bash
        run: |
          set -eux
          mkdir -p "$(dirname "$AAR_OUT")"
          gomobile bind -target=android -androidapi 26 -o "$AAR_OUT" "${{ github.event.inputs.pkg_path }}"
          test -f "$AAR_OUT"

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: outline.aar
          path: ${{ env.AAR_OUT }}
