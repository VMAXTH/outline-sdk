name: Build Android AAR

on:
  workflow_dispatch:
    inputs:
      pkg_path:
        description: 'Go-пакет для gomobile (например: ./x/mobileproxy)'
        required: true
        default: ./x/mobileproxy

jobs:
  build-aar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (с сабмодулями)
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Сборка Docker-образа gomobile
        run: |
          docker build -t gomobile-builder -f docker/gomobile/Dockerfile .

      - name: Связать пакет → AAR
        env:
          PKG: ${{ github.event.inputs.pkg_path }}
        run: |
          set -euo pipefail
          mkdir -p build/android
          docker run --rm -v "$PWD":/work gomobile-builder bash -lc '
            set -euo pipefail
            cd /work
            if [ -f "$PKG/go.mod" ]; then (cd "$PKG" && /usr/local/go/bin/go mod tidy); fi
            /go/bin/gomobile bind -target=android -androidapi 26 -o build/android/outline.aar "$PKG"
          '

      - name: Загрузка артефакта
        uses: actions/upload-artifact@v4
        with:
          name: outline.aar
          path: build/android/outline.aar
