name: Build Android AAR

on:
  workflow_dispatch:
    inputs:
      pkg_path:
        description: 'Go-пакет для gomobile (например: ./x/mobileproxy)'
        required: true
        default: ./x/mobileproxy

jobs:
  build-aar:
    runs-on: ubuntu-latest

    env:
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk
      GOPROXY: https://proxy.golang.org,direct
      GOSUMDB: sum.golang.org
      CGO_ENABLED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Go 1.22
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      # --- Android SDK/NDK (ручная установка, без flaky-экшенов) ---
      - name: Prepare SDK folders
        run: |
          set -eux
          sudo mkdir -p "$ANDROID_HOME"/{cmdline-tools/latest,platforms,build-tools,ndk}
          sudo chown -R $USER:$USER "$ANDROID_HOME"

      - name: Install cmdline-tools (resilient)
        run: |
          set -euxo pipefail
          cd "$ANDROID_HOME/cmdline-tools"
          base="https://dl.google.com/android/repository"
          # несколько кандидатов — берем первый доступный
          for z in \
            commandlinetools-linux-11076708_latest.zip \
            commandlinetools-linux-11079641_latest.zip \
            commandlinetools-linux-11076729_latest.zip
          do
            if curl -fsSL "$base/$z" -o /tmp/cmdtools.zip; then
              break
            fi
          done
          unzip -q /tmp/cmdtools.zip -d latest
          rm -f /tmp/cmdtools.zip
          yes | "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --licenses > /dev/null || true

      - name: Accept SDK licenses (CI-safe)
        run: |
          set -eux
          yes | "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --licenses || true

      - name: Install Android packages (robust)
        run: |
          set -euxo pipefail
          PKGS=(
            "platform-tools"
            "platforms;android-34"
            "build-tools;34.0.0"
            "ndk;28.2.13673558"
          )
          for p in "${PKGS[@]}"; do
            for i in {1..4}; do
              "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" "$p" && break || sleep 5
            done
          done

      - name: Locate NDK
        id: ndk
        run: |
          set -eux
          NDK_DIR=$(ls -d "$ANDROID_HOME/ndk/"*/ | sort | tail -n1)
          echo "NDK=$NDK_DIR" >> "$GITHUB_OUTPUT"
          echo "ANDROID_NDK_HOME=$NDK_DIR" >> "$GITHUB_ENV"

      # --- gomobile & bind ---
      - name: Install gomobile & gobind
        run: |
          set -eux
          go install golang.org/x/mobile/cmd/gomobile@latest
          # заранее тянем bind-пакет, чтобы не было "no Go package in golang.org/x/mobile/bind"
          go get golang.org/x/mobile/bind@latest
          go env

      - name: gomobile init
        run: |
          set -eux
          "$HOME/go/bin/gomobile" init -ndk "${{ steps.ndk.outputs.NDK }}"

      # --- go mod tidy в корне (если есть) и в самом пакете ---
      - name: go mod tidy (root)
        run: |
          set -eux
          if [ -f go.mod ]; then
            go mod tidy
          fi

      - name: go mod tidy (package)
        run: |
          set -eux
          PKG="${{ github.event.inputs.pkg_path }}"
          if [ -f "$PKG/go.mod" ]; then
            (cd "$PKG" && go mod tidy)
          fi

      # --- сборка AAR ---
      - name: Build AAR via gomobile bind
        run: |
          set -eux
          mkdir -p build/android
          "$HOME/go/bin/gomobile" bind \
            -target=android \
            -androidapi=26 \
            -o build/android/outline.aar \
            "${{ github.event.inputs.pkg_path }}"

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: outline.aar
          path: build/android/outline.aar
