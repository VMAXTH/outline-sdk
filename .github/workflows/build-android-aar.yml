name: Build Android AAR

on:
  workflow_dispatch:
    inputs:
      pkg_path:
        description: "Go-пакет для gomobile (например: ./x/mobileproxy)"
        required: true
        default: "./x/mobileproxy"

jobs:
  build-aar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build gomobile image
        run: |
          docker build -t gomobile-android -f docker/gomobile/Dockerfile .

      - name: Bind → AAR
        run: |
          set -eux
          mkdir -p build/android
          docker run --rm \
            -v "${{ github.workspace }}:/work" \
            -w "/work" \
            gomobile-android \
            bash -lc '
              set -eux
              go get golang.org/x/mobile/bind@latest
              go mod tidy
              gomobile init -ndk "$ANDROID_SDK_ROOT/ndk/26.1.10909125"
              gomobile bind -target=android -androidapi 26 \
                -o build/android/outline.aar \
                "${{ inputs.pkg_path }}"
              ls -la build/android
            '

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: outline-aar
          path: build/android/outline.aar
