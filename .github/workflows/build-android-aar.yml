name: Build Android AAR

on:
  workflow_dispatch:
    inputs:
      pkg_path:
        description: "Go-пакет для gomobile (например: ./x/mobileproxy)"
        required: true
        default: ./x/mobileproxy

env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_NDK_VERSION: 26.1.10909125
  ANDROID_API: 34
  BUILD_TOOLS: 34.0.0

jobs:
  build-aar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Go 1.22
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      # ---------- SDK: базовые директории ----------
      - name: Prepare SDK folders
        shell: bash
        run: |
          set -eux
          sudo mkdir -p "$ANDROID_SDK_ROOT"
          sudo chown -R "$USER":"$USER" "$ANDROID_SDK_ROOT"
          mkdir -p "$ANDROID_SDK_ROOT"/{cmdline-tools,platforms,platform-tools,build-tools,ndk}
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/emulator" >> $GITHUB_PATH

      # ---------- cmdline-tools: устойчивое скачивание ----------
      - name: Install cmdline-tools (resilient)
        shell: bash
        run: |
          set -eux
          cd "$ANDROID_SDK_ROOT"
          mkdir -p cmdline-tools/latest
          # от свежих к более старым
          for v in 11076702 10406996 9477386 9123335 8512546 8092744; do
            url="https://dl.google.com/android/repository/commandlinetools-linux-${v}_latest.zip"
            echo "Trying $url"
            if curl -fSL "$url" -o /tmp/cmdtools.zip; then
              unzip -q /tmp/cmdtools.zip -d cmdline-tools/latest
              rm -f /tmp/cmdtools.zip
              break
            fi
          done
          test -x "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH

      # ---------- Пакеты SDK с ретраями ----------
      - name: Accept SDK licenses (CI-safe)
        shell: bash
        run: |
          set -eux
          yes | sdkmanager --licenses > /dev/null

      - name: Install SDK packages (robust)
        shell: bash
        run: |
          set -eux
          pkgs=(
            "platform-tools"
            "platforms;android-${ANDROID_API}"
            "build-tools;${BUILD_TOOLS}"
            "ndk;${ANDROID_NDK_VERSION}"
          )
          for p in "${pkgs[@]}"; do
            echo "Installing $p"
            n=0
            until sdkmanager "$p"; do
              n=$((n+1))
              if [ $n -ge 5 ]; then
                echo "Failed to install $p after $n attempts" >&2
                exit 1
              fi
              sleep 5
            done
          done
          echo "$ANDROID_SDK_ROOT/build-tools/${BUILD_TOOLS}" >> $GITHUB_PATH

      # ---------- Go инструменты ----------
      - name: Install gomobile & gobind
        shell: bash
        run: |
          set -eux
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          go env

      # ---------- gomobile init с явным NDK ----------
      - name: gomobile init
        shell: bash
        run: |
          set -eux
          gomobile version || true
          gomobile init -ndk "$ANDROID_SDK_ROOT/ndk/${ANDROID_NDK_VERSION}"

      # ---------- Если в пакете есть go.mod — tidy ----------
      - name: Tidy module (if pkg has go.mod)
        shell: bash
        run: |
          set -eux
          PKG_PATH="${{ inputs.pkg_path }}"
          if [ -f "$PKG_PATH/go.mod" ]; then
            ( cd "$PKG_PATH" && go mod tidy )
          fi

      # ---------- Сборка AAR ----------
      - name: Build AAR via gomobile bind
        shell: bash
        run: |
          set -eux
          mkdir -p build/android
          gomobile bind \
            -target=android \
            -androidapi $ANDROID_API \
            -o build/android/outline.aar \
            "${{ inputs.pkg_path }}"
          ls -l build/android

      # ---------- Артефакт ----------
      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: outline-aar
          path: build/android/outline.aar
          if-no-files-found: error
